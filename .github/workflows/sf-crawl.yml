name: SF Crawl

on:
  workflow_dispatch:
    inputs:
      crawlId:
        required: true
        type: string
      siteUrl:
        required: true
        type: string

run-name: Crawl ${{ inputs.crawlId }}

permissions:
  contents: read
  packages: read

concurrency:
  group: sf-crawl-single
  cancel-in-progress: false

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull crawler image
        run: docker pull ghcr.io/${{ github.repository }}/sf-crawler:sf-19.8

      - name: Run crawl
        env:
          SF_LICENSE_NAME: ${{ secrets.SF_LICENSE_NAME }}
          SF_LICENSE_KEY: ${{ secrets.SF_LICENSE_KEY }}
          SF_MEMORY: ${{ secrets.SF_MEMORY }}
        run: |
          mkdir -p out
          docker run --rm \
            -e SF_LICENSE_NAME \
            -e SF_LICENSE_KEY \
            -e SF_MEMORY \
            -v "${PWD}/out:/crawl" \
            ghcr.io/${{ github.repository }}/sf-crawler:sf-19.8 \
            screamingfrogseospider \
              --crawl "${{ inputs.siteUrl }}" \
              --headless \
              --save-crawl \
              --export-tabs "Response Codes:All" \
              --output-folder "/crawl"

      - name: Upload CSV only
        uses: actions/upload-artifact@v4
        with:
          name: sf-crawl-${{ inputs.crawlId }}
          path: out/response_codes_all.csv
          retention-days: 1
